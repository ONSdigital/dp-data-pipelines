# Data transit requirements

[DIS706 Jira ticket](https://jira.ons.gov.uk/browse/DIS-706)

## Introduction

The recommendations below are predicated on the assumption that files should be uploaded to the DP Upload Service `/upload-new` endpoint. Files are uploaded to an S3 bucket that is already defined (for example, in the Sandbox environment, this is the "ons-dp-sandbox-encrypted-datasets" bucket). Files larger than 5MB are chunked, and these chunks are uploaded separately and reassembled in the "datasets" folder of the pre-defined bucket.

## Required fields for Transport Pipeline #3

The table below is copied from the AND Transfer of Input Files Solution Design [Transform pipeline #3](https://confluence.ons.gov.uk/display/DIS/Transfer+of+input+files#Transferofinputfiles-Transportpipeline#3) section.

| Field              | Required? | Description                                                                                                                      |
|--------------------|-----------|----------------------------------------------------------------------------------------------------------------------------------|
| fileAuthorEmail    | Mandatory | Email address of the file author. Used for notifications generated during data transformation and validation pipeline processing |
| fileAuthorUsername | Mandatory | Username of the file author. Used for notifications generated during data transformation and validation pipeline processing      |
| fileName           | Mandatory | Name of SDMX V2.0 to be transported to the data transformation and validation pipeline, and onwards to the static file system    |
| fileVersion        | Mandatory | Version number of the file. There may be a requirement to upload updated files of the same name                                  |
| isPublishable      | Mandatory | Whether the file is intended to by published to web and api users by the static file system                                      |
| licence            | Mandatory | The licence that applies to the file once published to web and api users                                                         |
| licenceUrl         | Mandatory | The url where the licence described by the licence field is located                                                              |
| manifestVersion    | Mandatory | A version number to allow the support different manifest fields in the future, if required                                       |
| path               | Mandatory | The file path that the file should be available at once published to web and api users                                           |
| aliasName          | Optional  | Alias for the file to be uploaded to the static file system                                                                      |
| collectionId       | Optional  | Id of an existing collection in Florence that the file should be attached to once it is uploaded to the static file system       |

## Data Transformation and Validation Pipeline requirements

Accept a `.tar` file via an S3 bucket containing the following files:
- `.xml` file to be transformed.
- `manifest.json` file containing the metadata required to process and upload the `.xml` file.
- Any additional files (e.g. supplementary distributions) that form part of the submission.

Upload the following files to the relevant API:
- `.csv` file of data from the `.xml` input file generated by the pipeline transform (to DP Upload Service API).
- `.json` file of catalog metadata associated with the `.csv` file generated by the pipeline transform (to DP Dataset API).
- Any additional files contained in the original `.tar` submission (to DP Upload Service API).

## Recommendations for `manifest.json` structure

Having reviewed the requirements for Transport Pipeline #3, the following fields should be included in the `manifest.json` file:

```json
{
    "manifestVersion": "integer",
    "dataset_id": "string",
    "fileAuthorEmail": "string",
    "fileAuthorUsername": "string",
    "isPublishable": "Optional boolean",
    "licence": "Optional string",
    "licenceUrl": "Optional string",
    "title": "Optional string",
    "aliasName": "Optional string"
}
```

Some of these fields are required only for interacting with the DP Upload Service (via `UploadServiceClient._get_upload_new_params()`), and some are used to configure the pipeline itself. Further information on each field is in the table below.

### `manifest.json` fields

| Field                | Required? | Used in pipeline?                                                                                             | Default value                                                               | Go struct       |
|----------------------|-----------|---------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|-----------------|
| `manifestVersion`    | Mandatory | No, would be used to validate the `manifest.json` file against a schema to ensure required fields are present | None                                                                        | None - internal |
| `dataset_id`         | Mandatory | Yes, to get transform details from `CONFIGURATION` in `dpypelines.pipeline.configuration.py`                  | None                                                                        | None - internal |
| `fileAuthorEmail`    | Mandatory | No, but could replace env var in `dpypelines.pipeline.shared.utils.get_submitter_email()`                     | None                                                                        | Unknown         |
| `fileAuthorUsername` | Mandatory | No, but could be used to personalise emails sent by `SesClient`                                               | None                                                                        | Unknown         |
| `isPublishable`      | Optional  | Yes, used in `UploadServiceClient._get_upload_new_params()`                                                   | False                                                                       | `FileMetadata`  |
| `licence`            | Optional  | Yes, used in `UploadServiceClient._get_upload_new_params()`                                                   | "Open Government Licence v3.0"                                              | `FileMetadata`  |
| `licenceUrl`         | Optional  | Yes, used in `UploadServiceClient._get_upload_new_params()`                                                   | "http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" | `FileMetadata`  |
| `title`              | Optional  | Yes, used in `UploadServiceClient._get_upload_new_params()`                                                   | Filename without extension                                                  | `FileMetadata`  |
| `aliasName`          | Optional  | Yes, used in `UploadServiceClient._get_upload_new_params()`                                                   | Filename with extension                                                     | `Resumable`     |

#### Go structs

[FileMetadata struct](https://github.com/ONSdigital/dp-api-clients-go/blob/main/files/data.go#L3)

[Resumable struct](https://github.com/ONSdigital/dp-upload-service/blob/develop/upload/upload.go#L19)